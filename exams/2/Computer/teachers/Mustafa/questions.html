<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ุงูุงุฎุชุจุงุฑ | ููุตูุชู</title>
<link href="../../../../../package/dist/tailwind.css" rel="stylesheet">
<link href="../../../../../fonts.css" rel="stylesheet">


<style>
.correct {
  background-color: #06762f !important; /* ุฃุฎุถุฑ ุฌููู */
  color: #fff !important;               /* ูุต ุฃุจูุถ */
}
.wrong {
  background-color: #d33333 !important; /* ุฃุญูุฑ ุฌููู */
  color: #fff !important;               /* ูุต ุฃุจูุถ */
}
</style>



<script>
    // ๐งน ุนูุฏ ุฏุฎูู ุตูุญุฉ ุงูุฃุณุฆูุฉุ ูุญุฐู ูู ุงูุจูุงูุงุช ุงููุคูุชุฉ ุงูุณุงุจูุฉ
function resetStudentData() {
    // ุญุฐู ุจูุงูุงุช ุงูุทุงูุจ ููุท
    localStorage.removeItem("studentInfo");

    // ููุงุญุธุฉ: ูุง ูุญุฐู rules ูุฃููุง ุซุงุจุชุฉ ููุทููุจุฉ ููู ุงุฎุชุจุงุฑ
    console.log("๐งน ุชู ุญุฐู ุจูุงูุงุช ุงูุทุงูุจ ุงูุณุงุจูุฉ ูู localStorage.");
}

// ุงุณุชุฏุนุงุก ุงูุฏุงูุฉ ุนูุฏ ุชุญููู ุงูุตูุญุฉ
window.addEventListener("load", resetStudentData);

</script>


<script src="db.js"></script>


<style>
/* ุชุฏุฑุฌุงุช ูุชุฃุซูุฑุงุช */
.selected { background-color: #4ade80 !important; color: #fff; }
.bg-gray-card { background-color: #f9fafb; }
.fadeIn { animation: fadeIn 0.5s ease-out forwards; }
@keyframes fadeIn { from {opacity:0; transform:scale(0.8);} to {opacity:1; transform:scale(1);} }
</style>
</head>
<body class="bg-gradient-to-br from-indigo-800 via-blue-700 to-cyan-600 font-[Cairo] min-h-screen flex flex-col">

<!-- ูุงูุฐุฉ ุฅุฏุฎุงู ุงูุงุณู -->
<div id="nameModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
  <div class="bg-white rounded-2xl p-8 w-80 text-center shadow-lg animate-fadeIn">
    <h2 class="text-xl font-bold mb-4">ูุฑุญุจุงู! ๐</h2>
    <p class="mb-4">ูู ูุถูู ุฃุฏุฎู ุงุณูู ููุจุฏุก ุจุงูุงุฎุชุจุงุฑ:</p>
    <input type="text" id="studentName" class="border border-gray-300 rounded px-4 py-2 w-full mb-4" placeholder="ุงุณูู ููุง">
    <button id="startBtn" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">ุงุจุฏุฃ ุงูุงุฎุชุจุงุฑ</button>
  </div>
</div>

<!-- ูุนูููุงุช ุงูุงุฎุชุจุงุฑ -->
<div class="bg-white shadow p-4 flex justify-between items-center sticky top-0 z-40">
  <div>
    <p>ุงูุทุงูุจ: <span id="displayName">---</span></p>
    <p>ุงูููุช ุงููุชุจูู: <span id="timer">00:00</span></p>
  </div>
  <div>
    <p>ุงูุฏุฑุฌุฉ ุงูุญุงููุฉ: <span id="currentScore">0</span></p>
    <p>ุงูุญุฏ ุงูุฃุฏูู ููุดูุงุฏุฉ: <span id="passingScore">0</span></p>
  </div>
</div>

<!-- ุงูุฃุณุฆูุฉ -->
<main id="questionsContainer" class="flex-1 p-4 space-y-4 overflow-auto"></main>

<!-- ุฃุฒุฑุงุฑ ุฃุณูู ุงูุตูุญุฉ -->
<div class="flex justify-center mb-6 space-x-4">
  <button id="checkBtn" class="bg-green-600 text-white px-6 py-2 rounded-full shadow-lg hover:bg-green-700 transition hidden">ุชุญูู ูู ุงูุฅุฌุงุจุงุช</button>
  <button id="finishBtn" class="bg-blue-600 text-white px-6 py-2 rounded-full shadow-lg hover:bg-blue-700 transition hidden">ุฅููุงุก ุงูุงุฎุชุจุงุฑ</button>
</div>
<!-- ูุงูุฐุฉ ุงููุชูุฌุฉ -->
<div id="resultModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
  <div id="resultContent" class="bg-white rounded-2xl p-6 w-96 text-center shadow-lg animate-fadeIn space-y-3 border-4">

    <h2 class="text-2xl font-bold">ูุชูุฌุฉ ุงูุงุฎุชุจุงุฑ</h2>

    <p>ุงุณู ุงูุทุงูุจ: <span id="studentNameDisplay"></span></p>
    <p>ุฏุฑุฌุชู: <span id="finalScore"></span></p>
    <p>ุฃุฏูู ุฏุฑุฌุฉ ูููุฌุงุญ: <span id="requiredScore"></span></p>
    <p>ุงูุฏุฑุฌุฉ ุงููุงููุฉ: <span id="fullScore"></span></p>
    <p>ุงูููุช ุงูููุฌุฒ: <span id="timeTaken"></span> ุฏูููุฉ</p>
    <p>ุชุงุฑูุฎ ุงูุฅููุงู: <span id="completionDate"></span></p>
    <p>ุงูุชูุฏูุฑ: <span id="rating"></span></p>

    <p id="passFail" class="font-bold text-xl"></p>

    <div class="flex justify-center space-x-4 mt-4">
      <!-- ุฒุฑ ุงูุดูุงุฏุฉ -->
      <button  id="certificateBtn" 
        class="bg-green-600 text-white px-6 py-2 rounded-full shadow-lg hover:bg-green-700 transition hidden">
        ุงุญุตู ุนูู ุงูุดูุงุฏุฉ
      </button>

      <!-- ุฒุฑ ุฅุนุงุฏุฉ ุงููุญุงููุฉ -->
      <button id="retryBtn" 
        class="bg-red-600 text-white px-6 py-2 rounded-full shadow-lg hover:bg-red-700 transition hidden">
        ุฅุนุงุฏุฉ ุงููุญุงููุฉ
      </button>
    </div>

  </div>
</div>


</div>



<script src="info_temp.js"></script>
<script src="rules.js"></script>

<script>
const displayName = document.getElementById("displayName");
const currentScoreEl = document.getElementById("currentScore");
const passingScoreEl = document.getElementById("passingScore");
const questionsContainer = document.getElementById("questionsContainer");
const checkBtn = document.getElementById("checkBtn");
const finishBtn = document.getElementById("finishBtn");
const timerEl = document.getElementById("timer");
const resultModal = document.getElementById("resultModal");
const finalScoreEl = document.getElementById("finalScore");
const requiredScoreEl = document.getElementById("requiredScore");
const passFailEl = document.getElementById("passFail");
const completionDateEl = document.getElementById("completionDate");
const certificateBtn = document.getElementById("certificateBtn");

// 1๏ธโฃ ูุงูุฐุฉ ุงูุงุณู
document.getElementById("startBtn").addEventListener("click", () => {
    const name = document.getElementById("studentName").value.trim();
    if(!name) return alert("ุงูุฑุฌุงุก ุฅุฏุฎุงู ุงุณูู");
    setStudentName(name);
    displayName.textContent = name;
    document.getElementById("nameModal").style.display = "none";
    startTest();
});

// 2๏ธโฃ ุฅุนุฏุงุฏุงุช ุงูุงุฎุชุจุงุฑ
passingScoreEl.textContent = rules.passingScore;

// 3๏ธโฃ ูุคูุช ุชูุงุฒูู
let remainingTime = rules.totalTime * 60;
let timerInterval;
function startTimer() {
    timerInterval = setInterval(() => {
        const min = String(Math.floor(remainingTime/60)).padStart(2,'0');
        const sec = String(remainingTime%60).padStart(2,'0');
        timerEl.textContent = `${min}:${sec}`;
        if(remainingTime<=0){
            clearInterval(timerInterval);
            finishTest();
        }
        remainingTime--;
    },1000);
}

// 4๏ธโฃ ุชูููุฏ ุงูุฃุณุฆูุฉ
function startTest(){
    startTimer();
    questionsContainer.innerHTML = "";
    studentInfo.currentScore=0;
    currentScoreEl.textContent=0;

    questions.forEach((q,index)=>{
        const card = document.createElement("div");
        card.className="bg-white p-4 rounded-2xl shadow space-y-2";
        let html=`<p class="font-semibold mb-2">${q.number}. ${q.question}</p>`;
        
        if(q.type==="MCQ" || q.type==="TrueFalse"){
            const options = q.type==="MCQ"? q.options : ["ุตุญ","ุฎุทุฃ"];
            options.forEach(opt=>{
                html+=`<button class="optionBtn bg-blue-100 hover:bg-blue-200 m-1 px-3 py-1 rounded" 
                    onclick="selectOption(this,'${q.correctAnswer}',${q.score})">${opt}</button>`;
            });
        } else if(q.type==="FillBlank"){
            html+=`<div class="flex gap-2">
                <input type="text" class="border border-gray-300 rounded px-3 py-1 flex-1" placeholder="ุงูุชุจ ุงูุฅุฌุงุจุฉ ููุง">
                <button class="bg-green-600 text-white px-4 rounded" onclick="submitFill(this, '${q.correctAnswer}', ${q.score})">ุชุฃููุฏ</button>
            </div>`;
        }

        card.innerHTML=html;
        questionsContainer.appendChild(card);
    });
}






function selectOption(el, correct, scoreValue) {
    const siblings = el.parentElement.querySelectorAll("button.optionBtn");
    const value = el.textContent.trim();

    if(value === correct) {
        // โ ุงูุฅุฌุงุจุฉ ุตุญูุญุฉ
        siblings.forEach(b => {
            if(b.textContent.trim() === correct){
                b.classList.add("correct"); // ุฃุฎุถุฑ ููุฎูุงุฑ ุงูุตุญูุญ
                b.dataset.score = scoreValue;
            } else {
                b.classList.add("wrong"); // ุฃุญูุฑ ูุจุงูู ุงูุฎูุงุฑุงุช ุงูุฎุงุทุฆุฉ
                b.dataset.score = 0;
            }
            b.disabled = true; // ููู ูู ุงูุฎูุงุฑุงุช ุจุนุฏ ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ
        });
    } else {
        // โ ุฅุฌุงุจุฉ ุฎุงุทุฆุฉ
        el.classList.add("wrong"); // ุฃุญูุฑ ููุท ููุฎูุงุฑ ุงููุฎุชุงุฑ
        el.dataset.score = 0;
        // ุจุงูู ุงูุฎูุงุฑุงุช ุชุจูู ููุง ููุ ููุง ูุชู ุงูููู
    }

    updateScoreDisplay();
    checkAllAnswered();
}





// 6๏ธโฃ ุชุฃููุฏ ุฅุฌุงุจุฉ ุงููุฑุงุบ (ูุณูุญ ุจุงููุญุงููุงุช ุญุชู ุชููู ุตุญูุญุฉ)
function submitFill(btn, correct, scoreValue) {
  const input = btn.previousElementSibling;
  const value = input.value.trim();
  const cleaned = value.replace(/\s+/g, '');
  const correctCleaned = correct.replace(/\s+/g, '');

  // ุฅุฐุง ูุงูุช ุงูุฅุฌุงุจุฉ ุตุญูุญุฉ โ
  if (cleaned === correctCleaned) {
    studentInfo.currentScore += scoreValue;
    updateScore(studentInfo.currentScore);
    currentScoreEl.textContent = studentInfo.currentScore;
    input.classList.remove("border-red-500");
    input.classList.add("border-green-500");
    input.disabled = true; // ๐ ููู ุจุนุฏ ุงููุฌุงุญ
    btn.disabled = true;
  } else {
    // ุฅุฐุง ูุงูุช ุงูุฅุฌุงุจุฉ ุฎุงุทุฆุฉ โ
    input.classList.remove("border-green-500");
    input.classList.add("border-red-500");
    // ูุณูุญ ูู ุจุงููุญุงููุฉ ูุฌุฏุฏูุง ุฏูู ููู ุงูุญูู
  }

  checkAllAnswered();
}



function updateScoreDisplay() {
  let total = 0;

  // โ ุญุณุงุจ ููุงุท ุงูุฃุณุฆูุฉ ุงูุงุฎุชูุงุฑูุฉ (MCQ ู TrueFalse)
  document.querySelectorAll(".optionBtn").forEach(btn => {
    const s = parseInt(btn.dataset.score);
    if (!isNaN(s) && s > 0) total += s;
  });

  // โ ุฅุถุงูุฉ ููุงุท ุฃุณุฆูุฉ ุงููุฑุงุบ (FillBlank)
  document.querySelectorAll("input.border-green-500").forEach(input => {
    const card = input.closest(".bg-white");
    const btn = card.querySelector("button");
    const s = parseInt(btn.getAttribute("onclick").match(/\d+\)$/)[0]) || 0;
    total += s;
  });

  // โ ุชุญุฏูุซ ูุนุฑุถ ุงูุฏุฑุฌุฉ ุงูููุงุฆูุฉ
  studentInfo.currentScore = total;
  currentScoreEl.textContent = total;
  updateScore(total);
}





function checkAllAnswered(){
    // ูุชุญูู ุฅุฐุง ูุงูุช ูู ุงูุจุทุงูุงุช ูุฏ ุชู ุงูุฅุฌุงุจุฉ ุนูููุง (MCQ ุฃู FillBlank)
    const allAnswered = Array.from(questionsContainer.children).every(card => {
        // ูุญุงูุงุช MCQ: ููุฌุฏ ุฒุฑ ูุฎุชุงุฑ (selected) ุฃู ุฃู ุฒุฑ ุชู ุงุฎุชูุงุฑู (correct ุฃู wrong)
        const optionAnswered = card.querySelector("button.optionBtn.correct") || 
                               card.querySelector("button.optionBtn.wrong");
        // ูุญุงูุงุช ุงููุฑุงุบ: ุญูู ุงูุฅุฏุฎุงู ูุนุทู ูุนูู ุชู ุงูุถุบุท ุนูู ุฒุฑ ุงูุชุฃููุฏ
        const fillAnswered = card.querySelector("input") && card.querySelector("input").value.trim() !== "";
        return optionAnswered || fillAnswered;
    });

    // ุฅุฐุง ุฌููุน ุงูุฃุณุฆูุฉ ุชูุช ุงูุฅุฌุงุจุฉ ุนูููุงุ ุฃุธูุฑ ุฒุฑ ุฅููุงุก ุงูุงุฎุชุจุงุฑ
    finishBtn.style.display = allAnswered ? "inline-block" : "none";
}









// ุนูุฏ ุงูุถุบุท ุนูู ุฒุฑ ุฅููุงุก ุงูุงุฎุชุจุงุฑ
finishBtn.addEventListener("click", finishTest);
function finishTest() {
    clearInterval(timerInterval);
    const timeTaken = rules.totalTime - Math.floor(remainingTime / 60);

    // ุชุญุฏูุซ ุจูุงูุงุช ุงูุทุงูุจ
    studentInfo.date = new Date().toLocaleString();
    studentInfo.timeTaken = timeTaken;

    if(!studentInfo.name) {
        studentInfo.name = document.getElementById("studentName").value.trim() || "ุทุงูุจ ูุฌููู";
    }

    // ุฌูุจ ุงูุฏุฑุฌุฉ ุงููุงููุฉ ูู localStorage
const totalScoreValue = parseInt(localStorage.getItem('totalScore')) || 0;

// ุชุญุฏูุฏ ุงูุชูุฏูุฑ ุจูุงุกู ุนูู ุงูุฏุฑุฌุฉ ุงููุนููุฉ
let rating = "";
if(studentInfo.currentScore === totalScoreValue){
    rating = "ููุชุงุฒ";
} else if(studentInfo.currentScore >= rules.passingScore){
    rating = "ุฌูุฏ";
} else {
    rating = "ููุจูู";
}
studentInfo.rating = rating;


    // ุชุญุฏูุซ ุนูุงุตุฑ ุงููุชูุฌุฉ ูู ุงูุตูุญุฉ
    document.getElementById("studentNameDisplay").textContent = studentInfo.name;
    finalScoreEl.textContent = studentInfo.currentScore;
    requiredScoreEl.textContent = rules.passingScore;
    document.getElementById("fullScore").textContent = totalScoreValue;
    document.getElementById("timeTaken").textContent = timeTaken;
    completionDateEl.textContent = studentInfo.date;
    document.getElementById("rating").textContent = rating;

    const retryBtn = document.getElementById("retryBtn");
    const resultContent = document.getElementById("resultContent");

    if(studentInfo.currentScore >= rules.passingScore){
        passFailEl.textContent = "ูุฌุญุช ๐";
        passFailEl.className = "font-bold text-xl text-green-600";
        resultContent.classList.remove("border-red-600");
        resultContent.classList.add("border-green-600");

        certificateBtn.style.display = "inline-block";
        certificateBtn.onclick = () => { window.location.href = "certificate.html"; };
        retryBtn.style.display = "none";
    } else {
        passFailEl.textContent = "ุฑุณุจุช ๐";
        passFailEl.className = "font-bold text-xl text-red-600";
        resultContent.classList.remove("border-green-600");
        resultContent.classList.add("border-red-600");

        retryBtn.style.display = "inline-block";
        retryBtn.onclick = () => { location.reload(); };
        certificateBtn.style.display = "none";
    }

    resultModal.style.display = "flex";

    // ุญูุธ ุงูุจูุงูุงุช ูู localStorage
    saveStudentInfo();

    // ๐ข ุฅุฑุณุงู ุงูุจูุงูุงุช ุฅูู Google Sheet ุจุฏูู ูุดุงูู CORS
  // ๐ข ุฅุฑุณุงู ุงูุจูุงูุงุช ุฅูู Google Sheet
const payload = {
    name: studentInfo.name,
    currentScore: studentInfo.currentScore,
    totalScore: localStorage.getItem('totalScore') || 0, // โ ุงุณุชุฎุฏู ุงููููุฉ ูู db.js
    timeTaken: studentInfo.timeTaken,
    date: studentInfo.date,
    rating: studentInfo.rating,
    teacher: rules.name_teacher,
    subject: rules.subject
};

    fetch("https://script.google.com/macros/s/AKfycby3TnqImviW0iecm8YxSvoLyrOsFusLIaEcNOC5LWOaecXdTmLtobAJVr-L6dorDcup/exec", {
        method: "POST",
        mode: "no-cors",                     // โ ูุชุฌุงูุฒ CORS
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
    })
    .catch(err => {
        console.warn("โ ูุง ูููู ุงูุชุญูู ูู ุงุณุชุฌุงุจุฉ Google Sheet ุจุณุจุจ no-cors:", err);
    });
}


</script>
    

</body>
</html>
